# THE PLAN

  The plan includes:                                                                                                                                                                                                                                                         
  - Complete production architecture: Gunicorn + Celery + Redis + NGINX + Docker                                                                                                                                                                                             
  - Full monitoring stack: Prometheus + Grafana with pre-built dashboards                                                                                                                                                                                                    
  - 5 implementation phases over 3-4 weeks                                                                                                                                                                                                                                   
  - Detailed verification steps including load testing                                                                                                                                                                                                                       
  - Rollback strategy for safe deployment                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
  The architecture will provide:                                                                                                                                                                                                                                             
  - 36 concurrent SSE connections                                                                                                                                                                                                                                            
  - 20 requests/min throughput                                                                                                                                                                                                                                               
  - <10s P95 latency                                                                                                                                                                                                                                                         
  - Graceful queue handling under load                                                                                                                                                                                                                                       
  - Full observability and metrics                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Ready to code?                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                             
 Here is Claude's plan:                                                                                                                                                                                                                                                      
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
 Production Backend Architecture Plan: Dhivehi Transliteration Service                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
 Target: Support 50 simultaneous users on internal network                                                                                                                                                                                                                   
 Timeline: 3-4 weeks (methodical, complete implementation)                                                                                                                                                                                                                   
 Approach: Full production architecture with monitoring                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Architecture Overview                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
 Users (Internal Network)                                                                                                                                                                                                                                                    
     ↓                                                                                                                                                                                                                                                                       
 NGINX Load Balancer (Rate Limiting + SSL)                                                                                                                                                                                                                                   
     ↓                                                                                                                                                                                                                                                                       
 Gunicorn Instances (3×4 workers = 12 SSE connections)                                                                                                                                                                                                                       
     ↓                                                                                                                                                                                                                                                                       
 Redis (Task Queue + Pub/Sub + Caching)                                                                                                                                                                                                                                      
     ↓                                                                                                                                                                                                                                                                       
 Celery Workers (4 instances, pre-loaded models)                                                                                                                                                                                                                             
     ↓                                                                                                                                                                                                                                                                       
 Prometheus + Grafana (Monitoring)                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
 Key Design Decisions:                                                                                                                                                                                                                                                       
 - Async Processing: Celery workers separate from request handling                                                                                                                                                                                                           
 - SSE Streaming: Redis pub/sub for real-time progress updates                                                                                                                                                                                                               
 - Model Efficiency: Pre-load once per worker (4 workers × 800MB = 3.2GB)                                                                                                                                                                                                    
 - Graceful Degradation: Queue system + rate limiting under load                                                                                                                                                                                                             
 - Full Observability: Prometheus metrics + Grafana dashboards                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 Expected Performance:                                                                                                                                                                                                                                                       
 - Max concurrent SSE connections: 36                                                                                                                                                                                                                                        
 - Throughput: 20 requests/min                                                                                                                                                                                                                                               
 - P95 latency: 8 seconds                                                                                                                                                                                                                                                    
 - Queue depth at peak: 10-15 requests                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Infrastructure Requirements (Internal Server)                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 Recommended Server Specs:                                                                                                                                                                                                                                                   
 - CPU: 8 cores (4 for web, 4 for workers)                                                                                                                                                                                                                                   
 - RAM: 8GB                                                                                                                                                                                                                                                                  
   - Celery workers: 3.2GB (4×800MB)                                                                                                                                                                                                                                         
   - Gunicorn: 1GB                                                                                                                                                                                                                                                           
   - Redis: 512MB                                                                                                                                                                                                                                                            
   - Prometheus + Grafana: 1GB                                                                                                                                                                                                                                               
   - OS + buffer: 2.3GB                                                                                                                                                                                                                                                      
 - Disk: 50GB (models, logs, metrics retention)                                                                                                                                                                                                                              
 - OS: Ubuntu 22.04 LTS (recommended)                                                                                                                                                                                                                                        
 - Network: Internal network with static IP                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Implementation Plan                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
 Phase 1: Production Server Setup (Week 1)                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
 Goal: Replace Flask dev server with production-ready Gunicorn                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 New Files:                                                                                                                                                                                                                                                                  
 1. gunicorn_config.py - Production WSGI configuration                                                                                                                                                                                                                       
 bind = "0.0.0.0:5001"                                                                                                                                                                                                                                                       
 workers = 4                                                                                                                                                                                                                                                                 
 worker_class = 'gevent'  # Async for SSE                                                                                                                                                                                                                                    
 worker_connections = 1000                                                                                                                                                                                                                                                   
 timeout = 300  # 5 minutes for long transliteration                                                                                                                                                                                                                         
 accesslog = '/var/log/gunicorn/access.log'                                                                                                                                                                                                                                  
 errorlog = '/var/log/gunicorn/error.log'                                                                                                                                                                                                                                    
 2. requirements.txt - Add new dependencies                                                                                                                                                                                                                                  
 # Existing                                                                                                                                                                                                                                                                  
 flask                                                                                                                                                                                                                                                                       
 transformers                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 # New                                                                                                                                                                                                                                                                       
 gunicorn                                                                                                                                                                                                                                                                    
 gevent                                                                                                                                                                                                                                                                      
 redis                                                                                                                                                                                                                                                                       
 celery                                                                                                                                                                                                                                                                      
 prometheus-client                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
 Modified Files:                                                                                                                                                                                                                                                             
 - app.py:                                                                                                                                                                                                                                                                   
   - Add health check endpoint: /health                                                                                                                                                                                                                                      
   - Add graceful error handling                                                                                                                                                                                                                                             
   - Configure CORS for internal network                                                                                                                                                                                                                                     
   - Add request timeout handling                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                             
 Tasks:                                                                                                                                                                                                                                                                      
 - Create gunicorn_config.py with gevent workers                                                                                                                                                                                                                             
 - Update requirements.txt                                                                                                                                                                                                                                                   
 - Add health check endpoint to app.py                                                                                                                                                                                                                                       
 - Configure logging (app logs + gunicorn logs)                                                                                                                                                                                                                              
 - Test: Run with gunicorn -c gunicorn_config.py app:app                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Phase 2: Task Queue + Workers (Week 2)                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 Goal: Implement Celery workers for async processing with Redis pub/sub                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 New Files:                                                                                                                                                                                                                                                                  
 1. celery_app.py - Celery task definitions                                                                                                                                                                                                                                  
   - Model singleton pattern (load once per worker)                                                                                                                                                                                                                          
   - Transliteration task with progress updates                                                                                                                                                                                                                              
   - Redis pub/sub for SSE event broadcasting                                                                                                                                                                                                                                
 2. redis_config.py - Redis connection configuration                                                                                                                                                                                                                         
   - DB 0: Celery broker                                                                                                                                                                                                                                                     
   - DB 1: Celery results                                                                                                                                                                                                                                                    
   - DB 2: SSE pub/sub                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
 Major Refactoring in app.py:                                                                                                                                                                                                                                                
 1. Split /transliterate endpoint:                                                                                                                                                                                                                                           
   - Current: Synchronous processing with yield                                                                                                                                                                                                                              
   - New: Submit task to Celery, stream from Redis pub/sub                                                                                                                                                                                                                   
 2. Move model loading:                                                                                                                                                                                                                                                      
   - Current: Model loaded at app startup (line 10-14)                                                                                                                                                                                                                       
   - New: Model loaded in Celery workers only                                                                                                                                                                                                                                
 3. Refactor progress updates:                                                                                                                                                                                                                                               
   - Current: Direct yield in SSE generator                                                                                                                                                                                                                                  
   - New: Publish to Redis channel, subscribe in SSE generator                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 Implementation Steps:                                                                                                                                                                                                                                                       
 # celery_app.py - Core logic                                                                                                                                                                                                                                                
 @celery_app.task(bind=True)                                                                                                                                                                                                                                                 
 def transliterate_task(self, text, request_id):                                                                                                                                                                                                                             
     model, tokenizer = get_model()  # Singleton pattern                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                             
     # Replace all `yield` with:                                                                                                                                                                                                                                             
     publish_progress(request_id, {                                                                                                                                                                                                                                          
         'status': status_msg,                                                                                                                                                                                                                                               
         'progress': progress_pct,                                                                                                                                                                                                                                           
         'thaana': partial_result                                                                                                                                                                                                                                            
     })                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 # app.py - New /transliterate endpoint                                                                                                                                                                                                                                      
 @app.route('/transliterate', methods=['POST'])                                                                                                                                                                                                                              
 def transliterate():                                                                                                                                                                                                                                                        
     request_id = str(time.time())                                                                                                                                                                                                                                           
     task = transliterate_task.delay(text, request_id)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
     def generate():                                                                                                                                                                                                                                                         
         pubsub = redis_client.pubsub()                                                                                                                                                                                                                                      
         pubsub.subscribe(f'transliteration:{request_id}')                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
         for message in pubsub.listen():                                                                                                                                                                                                                                     
             if message['type'] == 'message':                                                                                                                                                                                                                                
                 yield f"data: {message['data']}\n\n"                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
     return Response(generate(), mimetype='text/event-stream')                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 Tasks:                                                                                                                                                                                                                                                                      
 - Create celery_app.py with model singleton                                                                                                                                                                                                                                 
 - Move transliteration logic from app.py to celery_app.py                                                                                                                                                                                                                   
 - Refactor all yield statements to Redis pub/sub                                                                                                                                                                                                                            
 - Update /transliterate endpoint to submit Celery task                                                                                                                                                                                                                      
 - Add /stop/<request_id> support (publish stop signal)                                                                                                                                                                                                                      
 - Test: Run celery -A celery_app worker --loglevel=info --concurrency=1                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Phase 3: Load Balancing + Rate Limiting (Week 2-3)                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 Goal: Add NGINX for load balancing and rate limiting                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
 New Files:                                                                                                                                                                                                                                                                  
 1. nginx.conf - NGINX configuration                                                                                                                                                                                                                                         
   - Upstream: 3 Gunicorn instances (ports 5001, 5002, 5003)                                                                                                                                                                                                                 
   - Rate limiting: 10 req/min per IP, burst 5                                                                                                                                                                                                                               
   - SSE optimizations: proxy_buffering off                                                                                                                                                                                                                                  
   - Health checks                                                                                                                                                                                                                                                           
   - SSL/TLS (self-signed for internal network)                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                             
 Configuration:                                                                                                                                                                                                                                                              
 upstream dhivehi_app {                                                                                                                                                                                                                                                      
     least_conn;                                                                                                                                                                                                                                                             
     server 127.0.0.1:5001 max_fails=3 fail_timeout=30s;                                                                                                                                                                                                                     
     server 127.0.0.1:5002 max_fails=3 fail_timeout=30s;                                                                                                                                                                                                                     
     server 127.0.0.1:5003 max_fails=3 fail_timeout=30s;                                                                                                                                                                                                                     
 }                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
 limit_req_zone $binary_remote_addr zone=transliteration:10m rate=10r/m;                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                             
 server {                                                                                                                                                                                                                                                                    
     listen 80;                                                                                                                                                                                                                                                              
     listen 443 ssl;                                                                                                                                                                                                                                                         
     server_name transliteration.internal;                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
     ssl_certificate /etc/nginx/ssl/cert.pem;                                                                                                                                                                                                                                
     ssl_certificate_key /etc/nginx/ssl/key.pem;                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                             
     limit_req zone=transliteration burst=5 nodelay;                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
     # SSE-specific                                                                                                                                                                                                                                                          
     proxy_buffering off;                                                                                                                                                                                                                                                    
     proxy_cache off;                                                                                                                                                                                                                                                        
     proxy_read_timeout 600s;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
     location / {                                                                                                                                                                                                                                                            
         proxy_pass http://dhivehi_app;                                                                                                                                                                                                                                      
         proxy_set_header Host $host;                                                                                                                                                                                                                                        
         proxy_set_header X-Real-IP $remote_addr;                                                                                                                                                                                                                            
         proxy_http_version 1.1;                                                                                                                                                                                                                                             
         proxy_set_header Connection '';                                                                                                                                                                                                                                     
     }                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
     location /health {                                                                                                                                                                                                                                                      
         access_log off;                                                                                                                                                                                                                                                     
         proxy_pass http://dhivehi_app/health;                                                                                                                                                                                                                               
     }                                                                                                                                                                                                                                                                       
 }                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
 Tasks:                                                                                                                                                                                                                                                                      
 - Create nginx.conf with upstream and rate limiting                                                                                                                                                                                                                         
 - Generate self-signed SSL cert for internal network                                                                                                                                                                                                                        
 - Configure systemd services for 3 Gunicorn instances                                                                                                                                                                                                                       
 - Set up health check monitoring                                                                                                                                                                                                                                            
 - Test load balancing: send requests, verify distribution                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Phase 4: Containerization (Week 3)                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 Goal: Package everything with Docker for easy deployment                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
 New Files:                                                                                                                                                                                                                                                                  
 1. Dockerfile - Application container                                                                                                                                                                                                                                       
 FROM python:3.9-slim                                                                                                                                                                                                                                                        
 WORKDIR /app                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 # Install dependencies                                                                                                                                                                                                                                                      
 RUN apt-get update && apt-get install -y gcc g++                                                                                                                                                                                                                            
 COPY requirements.txt .                                                                                                                                                                                                                                                     
 RUN pip install --no-cache-dir -r requirements.txt                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 # Pre-download model (caches in image)                                                                                                                                                                                                                                      
 RUN python -c "from transformers import AutoModelForSeq2SeqLM; \                                                                                                                                                                                                            
     AutoModelForSeq2SeqLM.from_pretrained('Neobe/dhivehi-byt5-latin2thaana-v1')"                                                                                                                                                                                            
                                                                                                                                                                                                                                                                             
 COPY . .                                                                                                                                                                                                                                                                    
 EXPOSE 5001                                                                                                                                                                                                                                                                 
 CMD ["gunicorn", "-c", "gunicorn_config.py", "app:app"]                                                                                                                                                                                                                     
 2. docker-compose.yml - Service orchestration                                                                                                                                                                                                                               
 version: '3.8'                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                             
 services:                                                                                                                                                                                                                                                                   
   redis:                                                                                                                                                                                                                                                                    
     image: redis:7-alpine                                                                                                                                                                                                                                                   
     volumes:                                                                                                                                                                                                                                                                
       - redis_data:/data                                                                                                                                                                                                                                                    
     healthcheck:                                                                                                                                                                                                                                                            
       test: ["CMD", "redis-cli", "ping"]                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
   celery-worker:                                                                                                                                                                                                                                                            
     build: .                                                                                                                                                                                                                                                                
     command: celery -A celery_app worker --loglevel=info --concurrency=1                                                                                                                                                                                                    
     depends_on:                                                                                                                                                                                                                                                             
       - redis                                                                                                                                                                                                                                                               
     deploy:                                                                                                                                                                                                                                                                 
       replicas: 4                                                                                                                                                                                                                                                           
       resources:                                                                                                                                                                                                                                                            
         limits:                                                                                                                                                                                                                                                             
           memory: 1G                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
   web:                                                                                                                                                                                                                                                                      
     build: .                                                                                                                                                                                                                                                                
     depends_on:                                                                                                                                                                                                                                                             
       - redis                                                                                                                                                                                                                                                               
       - celery-worker                                                                                                                                                                                                                                                       
     deploy:                                                                                                                                                                                                                                                                 
       replicas: 3                                                                                                                                                                                                                                                           
     ports:                                                                                                                                                                                                                                                                  
       - "5001:5001"                                                                                                                                                                                                                                                         
       - "5002:5001"                                                                                                                                                                                                                                                         
       - "5003:5001"                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
   nginx:                                                                                                                                                                                                                                                                    
     image: nginx:alpine                                                                                                                                                                                                                                                     
     ports:                                                                                                                                                                                                                                                                  
       - "80:80"                                                                                                                                                                                                                                                             
       - "443:443"                                                                                                                                                                                                                                                           
     volumes:                                                                                                                                                                                                                                                                
       - ./nginx.conf:/etc/nginx/conf.d/default.conf                                                                                                                                                                                                                         
       - ./ssl:/etc/nginx/ssl                                                                                                                                                                                                                                                
     depends_on:                                                                                                                                                                                                                                                             
       - web                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                             
 volumes:                                                                                                                                                                                                                                                                    
   redis_data:                                                                                                                                                                                                                                                               
 3. .dockerignore - Exclude unnecessary files                                                                                                                                                                                                                                
 __pycache__/                                                                                                                                                                                                                                                                
 *.pyc                                                                                                                                                                                                                                                                       
 .git/                                                                                                                                                                                                                                                                       
 .env                                                                                                                                                                                                                                                                        
 venv/                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
 Tasks:                                                                                                                                                                                                                                                                      
 - Create Dockerfile with model pre-download                                                                                                                                                                                                                                 
 - Create docker-compose.yml with all services                                                                                                                                                                                                                               
 - Build image: docker-compose build                                                                                                                                                                                                                                         
 - Test locally: docker-compose up -d                                                                                                                                                                                                                                        
 - Verify all services healthy: docker-compose ps                                                                                                                                                                                                                            
 - Test end-to-end transliteration                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Phase 5: Monitoring + Observability (Week 3-4)                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                             
 Goal: Implement Prometheus + Grafana for full observability                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                             
 New Files:                                                                                                                                                                                                                                                                  
 1. monitoring.py - Prometheus metrics                                                                                                                                                                                                                                       
 from prometheus_client import Counter, Histogram, Gauge, generate_latest                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
 # Metrics                                                                                                                                                                                                                                                                   
 REQUEST_COUNT = Counter('transliteration_requests_total', 'Total requests')                                                                                                                                                                                                 
 REQUEST_DURATION = Histogram('transliteration_duration_seconds', 'Request duration')                                                                                                                                                                                        
 ACTIVE_REQUESTS = Gauge('transliteration_active_requests', 'Active requests')                                                                                                                                                                                               
 QUEUE_SIZE = Gauge('celery_queue_size', 'Tasks in queue')                                                                                                                                                                                                                   
 ERROR_COUNT = Counter('transliteration_errors_total', 'Total errors', ['error_type'])                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
 @app.route('/metrics')                                                                                                                                                                                                                                                      
 def metrics():                                                                                                                                                                                                                                                              
     return Response(generate_latest(), mimetype='text/plain')                                                                                                                                                                                                               
 2. prometheus.yml - Prometheus configuration                                                                                                                                                                                                                                
 global:                                                                                                                                                                                                                                                                     
   scrape_interval: 15s                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 scrape_configs:                                                                                                                                                                                                                                                             
   - job_name: 'transliteration'                                                                                                                                                                                                                                             
     static_configs:                                                                                                                                                                                                                                                         
       - targets: ['web:5001', 'web:5002', 'web:5003']                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                             
   - job_name: 'celery'                                                                                                                                                                                                                                                      
     static_configs:                                                                                                                                                                                                                                                         
       - targets: ['celery-worker:9090']                                                                                                                                                                                                                                     
 3. grafana_dashboard.json - Pre-built Grafana dashboard                                                                                                                                                                                                                     
   - Request rate (req/min)                                                                                                                                                                                                                                                  
   - P50/P95/P99 latency                                                                                                                                                                                                                                                     
   - Active requests gauge                                                                                                                                                                                                                                                   
   - Queue depth over time                                                                                                                                                                                                                                                   
   - Error rate by type                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 Update docker-compose.yml:                                                                                                                                                                                                                                                  
   prometheus:                                                                                                                                                                                                                                                               
     image: prom/prometheus:latest                                                                                                                                                                                                                                           
     volumes:                                                                                                                                                                                                                                                                
       - ./prometheus.yml:/etc/prometheus/prometheus.yml                                                                                                                                                                                                                     
       - prometheus_data:/prometheus                                                                                                                                                                                                                                         
     ports:                                                                                                                                                                                                                                                                  
       - "9090:9090"                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
   grafana:                                                                                                                                                                                                                                                                  
     image: grafana/grafana:latest                                                                                                                                                                                                                                           
     volumes:                                                                                                                                                                                                                                                                
       - grafana_data:/var/lib/grafana                                                                                                                                                                                                                                       
       - ./grafana_dashboard.json:/etc/grafana/provisioning/dashboards/dashboard.json                                                                                                                                                                                        
     ports:                                                                                                                                                                                                                                                                  
       - "3000:3000"                                                                                                                                                                                                                                                         
     environment:                                                                                                                                                                                                                                                            
       - GF_SECURITY_ADMIN_PASSWORD=admin                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
 Modified Files:                                                                                                                                                                                                                                                             
 - app.py: Import and use metrics from monitoring.py                                                                                                                                                                                                                         
 - celery_app.py: Add task execution metrics                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                             
 Tasks:                                                                                                                                                                                                                                                                      
 - Create monitoring.py with Prometheus metrics                                                                                                                                                                                                                              
 - Add metrics to request lifecycle (before/after request)                                                                                                                                                                                                                   
 - Create prometheus.yml configuration                                                                                                                                                                                                                                       
 - Add Prometheus + Grafana to docker-compose                                                                                                                                                                                                                                
 - Create Grafana dashboard JSON                                                                                                                                                                                                                                             
 - Test: Access Grafana at http://localhost:3000                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Critical Files Summary                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 Files to Modify:                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                             
 1. app.py (Major refactoring)                                                                                                                                                                                                                                               
   - Remove model loading (move to Celery)                                                                                                                                                                                                                                   
   - Refactor /transliterate to use Celery + Redis pub/sub                                                                                                                                                                                                                   
   - Add /health endpoint                                                                                                                                                                                                                                                    
   - Add metrics instrumentation                                                                                                                                                                                                                                             
   - Add error handling and timeouts                                                                                                                                                                                                                                         
 2. templates/index.html (Minor updates)                                                                                                                                                                                                                                     
   - Add SSE reconnection logic                                                                                                                                                                                                                                              
   - Improve error state handling                                                                                                                                                                                                                                            
   - Add queue position display (optional)                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
 Files to Create:                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                             
 1. gunicorn_config.py - Production server config                                                                                                                                                                                                                            
 2. celery_app.py - Worker task definitions                                                                                                                                                                                                                                  
 3. redis_config.py - Redis connection management                                                                                                                                                                                                                            
 4. monitoring.py - Prometheus metrics                                                                                                                                                                                                                                       
 5. nginx.conf - Load balancer config                                                                                                                                                                                                                                        
 6. Dockerfile - Container definition                                                                                                                                                                                                                                        
 7. docker-compose.yml - Service orchestration                                                                                                                                                                                                                               
 8. .dockerignore - Build optimization                                                                                                                                                                                                                                       
 9. prometheus.yml - Metrics scraping config                                                                                                                                                                                                                                 
 10. grafana_dashboard.json - Dashboard definition                                                                                                                                                                                                                           
 11. requirements.txt - Updated dependencies                                                                                                                                                                                                                                 
 12. README_DEPLOYMENT.md - Deployment guide                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Verification Steps                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 1. Unit Testing                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                             
 # Test model loading in Celery worker                                                                                                                                                                                                                                       
 celery -A celery_app worker --loglevel=debug                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 # Test single transliteration task                                                                                                                                                                                                                                          
 python -c "from celery_app import transliterate_task; \                                                                                                                                                                                                                     
     result = transliterate_task.delay('aharen', '123'); \                                                                                                                                                                                                                   
     print(result.get(timeout=30))"                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 2. Integration Testing                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 # Start all services                                                                                                                                                                                                                                                        
 docker-compose up -d                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
 # Check service health                                                                                                                                                                                                                                                      
 docker-compose ps                                                                                                                                                                                                                                                           
 curl http://localhost/health                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 # Test transliteration end-to-end                                                                                                                                                                                                                                           
 curl -X POST http://localhost/transliterate \                                                                                                                                                                                                                               
   -H "Content-Type: application/json" \                                                                                                                                                                                                                                     
   -d '{"text": "aharen miadhu varah ban du hai"}'                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                             
 # Monitor logs                                                                                                                                                                                                                                                              
 docker-compose logs -f web                                                                                                                                                                                                                                                  
 docker-compose logs -f celery-worker                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
 3. Load Testing                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                             
 # Install load testing tool                                                                                                                                                                                                                                                 
 pip install locust                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 # Create locustfile.py                                                                                                                                                                                                                                                      
 cat > locustfile.py << 'EOF'                                                                                                                                                                                                                                                
 from locust import HttpUser, task, between                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                             
 class TransliterationUser(HttpUser):                                                                                                                                                                                                                                        
     wait_time = between(1, 3)                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
     @task                                                                                                                                                                                                                                                                   
     def transliterate(self):                                                                                                                                                                                                                                                
         self.client.post("/transliterate", json={                                                                                                                                                                                                                           
             "text": "aharen miadhu varah ban du hai"                                                                                                                                                                                                                        
         })                                                                                                                                                                                                                                                                  
 EOF                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
 # Run load test (simulate 50 users)                                                                                                                                                                                                                                         
 locust -f locustfile.py --host=http://localhost --users 50 --spawn-rate 5                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
 4. Monitoring Verification                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                             
 # Access Grafana                                                                                                                                                                                                                                                            
 open http://localhost:3000                                                                                                                                                                                                                                                  
 # Login: admin/admin                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
 # Check Prometheus targets                                                                                                                                                                                                                                                  
 open http://localhost:9090/targets                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 # Query metrics                                                                                                                                                                                                                                                             
 curl http://localhost/metrics                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 5. Failover Testing                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
 # Stop one Gunicorn instance                                                                                                                                                                                                                                                
 docker-compose stop web_1                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
 # Verify requests still work (load balancer routes to web_2, web_3)                                                                                                                                                                                                         
 curl http://localhost/health                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 # Stop one Celery worker                                                                                                                                                                                                                                                    
 docker-compose stop celery-worker_1                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                             
 # Verify tasks still process (other workers pick up)                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Timeline Breakdown                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 Week 1: Foundation                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 - Days 1-2: Phase 1 (Production server)                                                                                                                                                                                                                                     
   - Create gunicorn config                                                                                                                                                                                                                                                  
   - Update requirements                                                                                                                                                                                                                                                     
   - Add health checks                                                                                                                                                                                                                                                       
   - Test Gunicorn with gevent                                                                                                                                                                                                                                               
 - Days 3-5: Phase 2 Part 1 (Celery setup)                                                                                                                                                                                                                                   
   - Create celery_app.py                                                                                                                                                                                                                                                    
   - Install Redis                                                                                                                                                                                                                                                           
   - Test basic Celery task                                                                                                                                                                                                                                                  
   - Implement model singleton                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 Week 2: Core Refactoring                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
 - Days 1-3: Phase 2 Part 2 (SSE refactoring)                                                                                                                                                                                                                                
   - Move transliteration logic to Celery                                                                                                                                                                                                                                    
   - Implement Redis pub/sub                                                                                                                                                                                                                                                 
   - Refactor /transliterate endpoint                                                                                                                                                                                                                                        
   - Test end-to-end streaming                                                                                                                                                                                                                                               
 - Days 4-5: Phase 3 (Load balancing)                                                                                                                                                                                                                                        
   - Create nginx.conf                                                                                                                                                                                                                                                       
   - Set up multiple Gunicorn instances                                                                                                                                                                                                                                      
   - Configure rate limiting                                                                                                                                                                                                                                                 
   - Generate SSL certs                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                             
 Week 3: Containerization                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                             
 - Days 1-2: Phase 4 (Docker)                                                                                                                                                                                                                                                
   - Create Dockerfile                                                                                                                                                                                                                                                       
   - Create docker-compose.yml                                                                                                                                                                                                                                               
   - Build and test containers                                                                                                                                                                                                                                               
   - Optimize image size                                                                                                                                                                                                                                                     
 - Days 3-5: Phase 5 (Monitoring)                                                                                                                                                                                                                                            
   - Create monitoring.py                                                                                                                                                                                                                                                    
   - Add Prometheus + Grafana                                                                                                                                                                                                                                                
   - Create dashboards                                                                                                                                                                                                                                                       
   - Test metrics collection                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                             
 Week 4: Testing + Deployment                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 - Days 1-2: Testing                                                                                                                                                                                                                                                         
   - Load testing (50 users)                                                                                                                                                                                                                                                 
   - Failover testing                                                                                                                                                                                                                                                        
   - Performance tuning                                                                                                                                                                                                                                                      
   - Fix bugs                                                                                                                                                                                                                                                                
 - Days 3-4: Documentation                                                                                                                                                                                                                                                   
   - Write deployment guide                                                                                                                                                                                                                                                  
   - Document architecture                                                                                                                                                                                                                                                   
   - Create runbooks                                                                                                                                                                                                                                                         
   - Training materials                                                                                                                                                                                                                                                      
 - Day 5: Production Deployment                                                                                                                                                                                                                                              
   - Deploy to internal server                                                                                                                                                                                                                                               
   - Configure monitoring alerts                                                                                                                                                                                                                                             
   - Handoff to operations                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Success Criteria                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                             
 - Handles 50 simultaneous SSE connections                                                                                                                                                                                                                                   
 - P95 latency < 10 seconds                                                                                                                                                                                                                                                  
 - No requests dropped (graceful queueing)                                                                                                                                                                                                                                   
 - Rate limiting prevents abuse (10 req/min per IP)                                                                                                                                                                                                                          
 - Grafana dashboard shows real-time metrics                                                                                                                                                                                                                                 
 - All services auto-restart on failure                                                                                                                                                                                                                                      
 - Zero downtime during single service failure                                                                                                                                                                                                                               
 - Complete documentation for operations team                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                             
 ---                                                                                                                                                                                                                                                                         
 Rollback Plan                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                             
 If issues arise during deployment:                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                             
 1. Keep existing app.py running in parallel on different port (5000)                                                                                                                                                                                                        
 2. Test new architecture on port 80 (NGINX)                                                                                                                                                                                                                                 
 3. If critical bugs: Switch NGINX upstream back to port 5000                                                                                                                                                                                                                
 4. Gradual migration: Route 10% → 50% → 100% of traffic to new architecture  